. ".\functions.ps1"

az login

# Allow installing extensions without prompt
az config set extension.use_dynamic_install=yes_without_prompt

# Gets the details for the currently logged-in user
$principalObjectId=$(az ad signed-in-user show --query objectId --output tsv)

$resourceGroup="asset-tracking-rg"
$location="northeurope"
$iotHub="asset-tracking-hub"
$iotHubSku="S1"
$iotHubSharedAccessPolicy="iothubowner"


#----------------------------------------------------------------------------------------------------
# Create a resource group
az group create --name $resourceGroup --location $location

#----------------------------------------------------------------------------------------------------
# Create an IoT Hub
# See: https://docs.microsoft.com/en-us/azure/iot-dps/quick-setup-auto-provision#create-an-iot-hub
#      https://docs.microsoft.com/en-us/cli/azure/iot/hub?view=azure-cli-latest#az_iot_hub_create

az iot hub create `
    --name $iotHub `
    --resource-group $resourceGroup `
    --location $location `
    --sku $iotHubSku

$iotHubConnection=$(az iot hub connection-string show -n $iotHub --output tsv)

#----------------------------------------------------------------------------------------------------
# Create an Azure IoT Hub device provisioning service (DPS)
# See: https://docs.microsoft.com/en-us/cli/azure/iot/dps?view=azure-cli-latest#az_iot_dps_create

$dps="asset-tracking-dps"
$dpsSku="S1"

az iot dps create `
    --name $dps `
    --resource-group $resourceGroup `
    --location $location `
    --sku $dpsSku

az iot dps linked-hub create `
    --dps-name $dps `
    --resource-group $resourceGroup `
    --location $location `
    --connection-string $iotHubConnection

#----------------------------------------------------------------------------------------------------
# Create DPS Enrollment Group
# See: https://docs.microsoft.com/en-us/cli/azure/iot/dps/enrollment-group?view=azure-cli-latest#az_iot_dps_enrollment_group_create

# Create primary and secondary keys
$primaryKey=Get-RandomKey
$secondaryKey=Get-RandomKey

# DPS Enrollment Group name
$enrollmentId="AssetTrackers"

az iot dps enrollment-group create `
    -g $resourceGroup `
    --dps-name $dps `
    --enrollment-id $enrollmentId `
    --primary-key $primaryKey `
    --secondary-key $secondaryKey

# Read DPS ID Scope
$idScope=$(az iot dps show --name $dps --resource-group $resourceGroup --query properties.idScope --output tsv)


#----------------------------------------------------------------------------------------------------
# Create an Azure Time Series Insights Gen2
# See: https://docs.microsoft.com/en-us/azure/time-series-insights/how-to-create-environment-using-cli

# Create an Azure storage account for tsi environment's cold store

$randomString=Get-RandomLowercaseAndNumbers 16
$tsiStorage="storage"+$randomString

az storage account create -g $resourceGroup -n $tsiStorage --https-only
$key=$(az storage account keys list -g $resourceGroup -n $tsiStorage --query [0].value --output tsv)

# Create the Azure Time Series Insights Environment
# See: https://docs.microsoft.com/en-us/cli/azure/tsi/environment/gen2?view=azure-cli-latest#az_tsi_environment_gen2_create

$tsiEnvName="time-series-insights"
$tsiPropertyId="iothub-connection-device-id"
$tsiSkuName="L1"

az tsi environment gen2 create `
    --name $tsiEnvName `
    --location $location `
    --resource-group $resourceGroup `
    --sku name=$tsiSkuName capacity=1 `
    --time-series-id-properties name=$tsiPropertyId type=String `
    --warm-store-configuration data-retention=P7D `
    --storage-configuration account-name=$tsiStorage management-key=$key

# Create an event source under the specified environmen
# See: https://docs.microsoft.com/en-us/cli/azure/tsi/event-source/iothub?view=azure-cli-latest

# Read the "iothubowner" Shared Access Policy key of the IoT Hub
# See: https://docs.microsoft.com/en-us/cli/azure/iot/hub/policy?view=azure-cli-latest#az_iot_hub_policy_show

$policySharedAccessKey=$(az iot hub policy show --hub-name $iotHub --name $iotHubSharedAccessPolicy --query primaryKey --output tsv)

# Read IoT Hub resource id
$resourceId=$(az iot hub show --name $iotHub --query id --output tsv)

$eventSourceName="ioteventsource"
$consumerGroupName="iothubgroup"
$eventSourceKeyName=$iotHubSharedAccessPolicy

az tsi event-source iothub create `
    -g $resourceGroup `
    --environment-name $tsiEnvName `
    --name $eventSourceName `
    --consumer-group-name $consumerGroupName `
    --iot-hub-name $iotHub `
    --location $location `
    --key-name $eventSourceKeyName `
    --shared-access-key $policySharedAccessKey `
    --event-source-resource-id $resourceId

# Create a data access policy granting access to the signed in user
# See: https://docs.microsoft.com/en-us/cli/azure/tsi/access-policy?view=azure-cli-latest

az tsi access-policy create `
    --name "roleAssignment" `
    --environment-name $tsiEnvName `
    --description "TSI owner" `
    --principal-object-id $principalObjectId `
    --roles Reader Contributor `
    --resource-group $resourceGroup
